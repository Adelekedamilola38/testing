name: Run tests with Postgres

on: [push, pull_request]

jobs:
    tests:
        runs-on: ubuntu-latest
        services:
            postgres:
                image: postgres:14
                env:
                    POSTGRES_USER: postgres
                    POSTGRES_PASSWORD: postgres
                    POSTGRES_DB: test_db
                options: >-
                    --health-cmd="pg_isready -U postgres" --health-interval=10s --health-timeout=5s --health-retries=5
                ports: ['5432:5432']
        steps:
            - uses: actions/checkout@v4
            - name: Set up Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.10'
            - name: Install deps and run tests
              run: |
                pip install -r requirements.txt
                pytest -v --html=tests/report.html --self-contained-html
              env:
                DB_HOST: localhost
                DB_PORT: 5432
                DB_USER: postgres
                DB_PASSWORD: postgres
                DB_NAME: test_db
              
